version: "3.9"

networks:
  orth-net:
    driver: bridge

# ynl anchor, alias
x-logging: &rolling-logs
  driver: "json-file"
  options:
    max-size: "${LOG_MAX_SIZE}"
    max-file: "${LOG_MAX_FILE}"

services:
  orth-admin:
    pull_policy: build   # 只构建，不从 registry 拉取
    build:
      context: .
      dockerfile: orth-admin/Dockerfile
      # args:
        # Build argument
        # APP_VERSION: "${ADMIN_VERSION}"
    image: "${REGISTRY}${REPO_PREFIX}orth-admin:${ADMIN_VERSION}"
    container_name: orth-admin
    restart: unless-stopped
    networks: [orth-net]
    ports:
      - "${ADMIN_HTTP_PORT}:8080"
      - "${ADMIN_DEBUG_PORT}:5005"
    environment:
      SPRING_DATASOURCE_URL: "jdbc:mysql://${MYSQL_HOST}:${MYSQL_PORT}/${MYSQL_DB}?useUnicode=true&characterEncoding=UTF-8&autoReconnect=true&serverTimezone=${TZ}"
      SPRING_DATASOURCE_USERNAME: "${MYSQL_USER}"
      SPRING_DATASOURCE_PASSWORD: "${MYSQL_PASSWORD}"
      ORTH_JOB_ACCESSTOKEN: "${ORTH_JOB_ACCESS_TOKEN}"
      TZ: "${TZ}"
    volumes:
      - "${ADMIN_DATA_DIR}/applogs:/data/applogs"
      - "${ADMIN_DATA_DIR}/gclogs:/data/gclogs"
    logging: *rolling-logs
    healthcheck:
      test: ["CMD-SHELL", "bash -lc \"timeout 2 bash -lc 'echo > /dev/tcp/127.0.0.1/8080' || exit 1\""]
      interval: 20s
      timeout: 5s
      start_period: 20s
      retries: 5
    labels:
      # container labels
      org.opencontainers.image.title: "orth-admin"
      org.opencontainers.image.version: "${ADMIN_VERSION}"
      org.opencontainers.image.revision: "${GIT_SHA}"
      org.opencontainers.image.created: "${BUILD_DATE}"
    deploy:
      resources:
        limits:
          memory: 500M
          cpus: "4.0"
    security_opt:
      - no-new-privileges:true

  orth-ui:
    image: nginx:1.27-alpine
    container_name: orth-ui
    restart: unless-stopped
    networks: [orth-net]
    ports:
      - "${UI_HTTP_PORT}:80"
    volumes:
      - ./orth-ui/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./orth-ui/dist:/usr/share/nginx/html/orth-admin:ro
    depends_on:
      orth-admin:
        condition: service_healthy
    logging: *rolling-logs
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: "1.0"
    security_opt:
      - no-new-privileges:true

  orth-worker-1:
    pull_policy: build   # 只构建，不从 registry 拉取
    build:
      context: .
      dockerfile: orth-executor-samples/orth-executor-sample-springboot/Dockerfile
      # args:
      #   APP_VERSION: "${WORKER_VERSION}"
    image: "${REGISTRY}${REPO_PREFIX}orth-worker:${WORKER_VERSION}"
    container_name: orth-worker-1
    restart: unless-stopped
    networks: [orth-net]
    # 9999 port;
    # only expose jvm debug port
    ports:
      - "${WORKER1_DEBUG_PORT}:5005"
    environment:
      TZ: "${TZ}"
      ORTH_JOB_ADMIN_ADDRESSES: "http://orth-admin:8080/orth-admin"
      ORTH_JOB_ADMIN_ACCESSTOKEN: "${ORTH_JOB_ACCESS_TOKEN}"
      ORTH_JOB_EXECUTOR_APPNAME: "${WORKER1_APPNAME}"
      ORTH_JOB_EXECUTOR_PORT: "${WORKER_EXECUTOR_PORT}"
      ORTH_JOB_EXECUTOR_LOGPATH: "/data/applogs/orth/jobhandler"
      ORTH_JOB_EXECUTOR_LOGRETENTIONDAYS: "7"
    volumes:
      - "${WORKER1_DATA_DIR}/applogs:/data/applogs"
      - "${WORKER1_DATA_DIR}/gclogs:/data/gclogs"
    logging: *rolling-logs
    healthcheck:
      test: ["CMD-SHELL", "bash -lc \"timeout 2 bash -lc 'echo > /dev/tcp/127.0.0.1/${ORTH_JOB_EXECUTOR_PORT:-9999}' || exit 1\""]
      interval: 20s
      timeout: 5s
      start_period: 20s
      retries: 5
    labels:
      org.opencontainers.image.title: "orth-worker"       
      org.opencontainers.image.version: "${WORKER_VERSION}"
      org.opencontainers.image.revision: "${GIT_SHA}"
      org.opencontainers.image.created: "${BUILD_DATE}"
    deploy:
      resources:
        limits:
          memory: 400M
          cpus: "4.0"
    security_opt:
      - no-new-privileges:true

  orth-worker-2:
    pull_policy: build   # 只构建，不从 registry 拉取
    build:
      context: .
      dockerfile: orth-executor-samples/orth-executor-sample-springboot/Dockerfile
      # args:
      #   APP_VERSION: "${WORKER_VERSION}"
    image: "${REGISTRY}${REPO_PREFIX}orth-worker:${WORKER_VERSION}"
    container_name: orth-worker-2
    restart: unless-stopped
    networks: [orth-net]
    ports:
      - "${WORKER2_DEBUG_PORT}:5005"
    environment:
      TZ: "${TZ}"
      ORTH_JOB_ADMIN_ADDRESSES: "http://orth-admin:8080/orth-admin"
      ORTH_JOB_ADMIN_ACCESSTOKEN: "${ORTH_JOB_ACCESS_TOKEN}"
      ORTH_JOB_EXECUTOR_APPNAME: "${WORKER2_APPNAME}"
      ORTH_JOB_EXECUTOR_PORT: "${WORKER_EXECUTOR_PORT}"
      ORTH_JOB_EXECUTOR_LOGPATH: "/data/applogs/orth/jobhandler"
      ORTH_JOB_EXECUTOR_LOGRETENTIONDAYS: "7"
    volumes:
      - "${WORKER2_DATA_DIR}/applogs:/data/applogs"
      - "${WORKER2_DATA_DIR}/gclogs:/data/gclogs"
    logging: *rolling-logs
    healthcheck:
      test: ["CMD-SHELL", "bash -lc \"timeout 2 bash -lc 'echo > /dev/tcp/127.0.0.1/${ORTH_JOB_EXECUTOR_PORT:-9999}' || exit 1\""]
      interval: 20s
      timeout: 5s
      start_period: 20s
      retries: 5
    labels:
      org.opencontainers.image.title: "orth-worker"
      org.opencontainers.image.version: "${WORKER_VERSION}"
      org.opencontainers.image.revision: "${GIT_SHA}"
      org.opencontainers.image.created: "${BUILD_DATE}"
    deploy:
      resources:
        limits:
          memory: 400M
          cpus: "4.0"
    security_opt:
      - no-new-privileges:true